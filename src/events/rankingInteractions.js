// src/events/rankingInteractions.js

const {
    ModalBuilder,
    TextInputBuilder,
    TextInputStyle,
    ActionRowBuilder,
    StringSelectMenuBuilder,
    StringSelectMenuOptionBuilder,
  } = require('discord.js');
  
  const { rateWork, getAllByCategory } = require('../database/rankingManager');
  
  // Les 6 cat√©gories qu'on g√®re
  const allCategories = ["Manga","Manhwa","Manhua","Serie","Film","Anime"];
  
  module.exports = {
    name: 'interactionCreate',
    async execute(interaction) {
      // 1) Bouton "Ajouter/Noter une ≈ìuvre" => on montre un Select Menu
      if (interaction.isButton() && interaction.customId === "rank_addRate") {
        // Cr√©er un select menu
        const select = new StringSelectMenuBuilder()
          .setCustomId("rank_addRateSelect")
          .setPlaceholder("Choisir une cat√©gorie");
  
        // Ajouter les options
        allCategories.forEach(cat => {
          select.addOptions(
            new StringSelectMenuOptionBuilder()
              .setLabel(cat)
              .setValue(cat)
              .setEmoji(
                cat === "Manga" ? "üáØüáµ" :
                cat === "Manhwa" ? "üá∞üá∑" :
                cat === "Manhua" ? "üá®üá≥" :
                cat === "Serie"  ? "üéûÔ∏è" :
                cat === "Film"   ? "üé¨" :
                cat === "Anime"  ? "üî•" :
                "‚ùì"
              )
          );
        });
  
        const row = new ActionRowBuilder().addComponents(select);
  
        return interaction.reply({
          content: "Dans quelle cat√©gorie veux-tu noter une ≈ìuvre ?",
          components: [row],
          ephemeral: true
        });
      }
  
      // 2) S√©lection d'une cat√©gorie pour l'ajout => on ouvre un modal
      if (interaction.isStringSelectMenu() && interaction.customId === "rank_addRateSelect") {
        const chosenCat = interaction.values[0]; // la valeur s√©lectionn√©e
  
        // Construire un modal
        const modal = new ModalBuilder()
          .setCustomId("rank_addRateModal|" + chosenCat) // on encode la cat√©gorie dans le customId
          .setTitle("Ajouter/Noter une ≈ìuvre");
  
        // Champ titre de l'oeuvre
        const titleInput = new TextInputBuilder()
          .setCustomId("workTitle")
          .setLabel("Titre de l'≈ìuvre")
          .setStyle(TextInputStyle.Short)
          .setPlaceholder("Ex: One Piece")
          .setRequired(true);
  
        // Champ note
        const ratingInput = new TextInputBuilder()
          .setCustomId("workRating")
          .setLabel("Note (1 √† 5)")
          .setStyle(TextInputStyle.Short)
          .setRequired(true);
  
        const row1 = new ActionRowBuilder().addComponents(titleInput);
        const row2 = new ActionRowBuilder().addComponents(ratingInput);
  
        modal.addComponents(row1, row2);
  
        return interaction.showModal(modal);
      }
  
      // 3) Soumission du modal
      if (interaction.isModalSubmit() && interaction.customId.startsWith("rank_addRateModal")) {
        // R√©cup√©rer la cat√©gorie encod√©e
        const splitted = interaction.customId.split("|");
        const category = splitted[1];
  
        const title = interaction.fields.getTextInputValue("workTitle");
        const ratingStr = interaction.fields.getTextInputValue("workRating");
        const rating = parseInt(ratingStr, 10);
  
        if (isNaN(rating) || rating < 1 || rating > 5) {
          return interaction.reply({
            content: "La note doit √™tre un entier entre 1 et 5.",
            ephemeral: true
          });
        }
  
        // Appeler la fonction pour noter
        await rateWork(interaction.guildId, interaction.user.id, category, title, rating);
  
        // R√©pondre
        await interaction.reply({
          content: `Merci ! Tu as not√© **${title}** (cat√©gorie **${category}**) : ${rating}/5`,
          ephemeral: true
        });
  
        // (Optionnel) Mettre √† jour le message global (embed) ici si tu le souhaites.
        return;
      }
  
      // 4) Bouton "Consulter" => on affiche un Select Menu de cat√©gorie
      if (interaction.isButton() && interaction.customId === "rank_consult") {
        const select = new StringSelectMenuBuilder()
          .setCustomId("rank_consultSelect")
          .setPlaceholder("Choisir une cat√©gorie");
  
        allCategories.forEach(cat => {
          select.addOptions(
            new StringSelectMenuOptionBuilder()
              .setLabel(cat)
              .setValue(cat)
              .setEmoji(
                cat === "Manga" ? "üáØüáµ" :
                cat === "Manhwa" ? "üá∞üá∑" :
                cat === "Manhua" ? "üá®üá≥" :
                cat === "Serie"  ? "üéûÔ∏è" :
                cat === "Film"   ? "üé¨" :
                cat === "Anime"  ? "üî•" :
                "‚ùì"
              )
          );
        });
  
        const row = new ActionRowBuilder().addComponents(select);
  
        return interaction.reply({
          content: "Quelle cat√©gorie souhaites-tu consulter ?",
          components: [row],
          ephemeral: true
        });
      }
  
      // 5) S√©lection d'une cat√©gorie pour la consultation => On affiche la liste
      if (interaction.isStringSelectMenu() && interaction.customId === "rank_consultSelect") {
        const chosenCat = interaction.values[0];
        const works = await getAllByCategory(interaction.guildId, chosenCat);
  
        if (works.length === 0) {
          return interaction.reply({
            content: `Aucune ≈ìuvre dans la cat√©gorie **${chosenCat}**.`,
            ephemeral: true
          });
        }
  
        // Construire un petit message ou un embed
        let text = `Voici la liste des ≈ìuvres dans **${chosenCat}** :\n`;
        works.forEach((w, i) => {
          text += `**#${i+1}** ${w.title} ‚Äî note moyenne : ${w.average_rating.toFixed(2)}/5 (bas√© sur ${w.rating_count} avis)\n`;
        });
  
        return interaction.reply({ content: text, ephemeral: true });
      }
    },
  };
  